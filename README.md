### Плагин Мостовые сооружения

#### Функции, реализованные в плагине

- Добавление
- Редактирование семантики
- Копирование
- Удаление
- Перемещение (аналогично редактору геометрии)
- Поворот
- Редактирование геометрии
- Информация о мосте
- Создание паспорта моста в формате RTF
- Сводная ведомость мостов
- Создание отчёта по сводной ведомости в формате RTF
- Статусы

#### Порядок добавления мостового сооружения на карту

1. Нажать на кнопку "Добавить мост"
2. Нарисовать нажатиями левой кнопки мыши осевую линию моста (последняя точка ставится нажатием правой кнопки мыши). Затем выбрать ширину и/или тип точек буферной зоны моста в открывшемся окне.
3. Заполнить данные моста в открывшемся окне, заполнять удобнее всего в порядке сверху вниз и слева направо
4. Нажать кнопку "Ок"

#### Копирование мостового сооружения

1. Нажать на кнопку копирования на панели
2. Нажать левой кнопкой мыши на осевую моста
3. Нажать правой кнопкой мыши на место, куда нужно произвести копирование

#### Описание проектов в решении

- **ITS.Core.Bridges** - проект ядра, содержит:
  - типы, описывающие предметную область, в папке Domain
    -  `Bridge` - мостовое сооружение
    -  `BridgeObstacle` - пересекаемое препятствие
    -  `BridgeSupport` - опора
    -  `Defect` - дефект
    -  `DefectScrollSection` - раздел дефекта
    -  `DefectType` - тип дефекта
    -  `DocumentationInfo` - информация о технической документации
    -  `IBridgeReferenceable` - интерфейс, для типов, ссылающихся на `Bridge`
    -  `InfoOfRepairs` - информация о ремонтах, реконструкциях
    -  `INumberable` - интерфейс для типов, имеющих порядковый номер
    -  `Material` - материал
    -  `Protection` - ограждение
    -  `SpanBeam` - балка
    -  `SpanStructure` - пролётное строение
    -  `Territory` - территория
    -  `TypicalProject` - типовой проект
  - перечисления из предметной области, в папках 
    - `Domain/EnumText` - текстовые файлы для генерации перечислений и конвертеров с помощью [EnumGenerator](https://github.com/luntiklaelite/classToMapping)
    - `Domain/Enums` - перечисления
    - `Domain/EnumStrings` - конвертеры перечислений в строку и обратно
  - вспомогательные классы, в папке Helpers
    - `BridgeReportMaker` - генератор информации для паспорта 
    - `DefectParamsParser` - парсер параметров дефектов
    - `DesignBurdensInfo` - класс с массивом названий проектных нагрузок
    - `DefectsHelper` - класс, выдающий описание по названию параметра дефекта
- **ITS.Services.BridgesServices** - проект сервера
- **ITS.MapObjects.BridgesMapObject** - проект клиента, содержит:
  - контролы для добавления нескольких элементов, в папке Controls
    - `AddableListBox` - отображает элементы списком, использует `ToString()` для отображения
    - `AddableTreeView` - отображает элементы деревом TreeView, требует дополнительно написания класса-преобразователя в дерево
  - `EditViewHelper` - класс, предоставляющий методы по установке и получению значений разных типов данных из разных контролов
- **ITS.Data.Bridges** - проект с маппингами и DAO, содержит:
  -  объектно-реляционные маппинги, генерируемые  с помощью [MappingGenerator](https://github.com/luntiklaelite/classToMapping) (не универсальное решение, требуется настройка на плагин и написание кода определённым образом)
  -  классы DAO, реализующие различные методы по работе с базой данных
- **ITS.DbMigration.Bridges** - проект с миграциями базы данных
  - миграции генерируются из файлов с классами предметной области с помощью [MigrationGenerator](https://github.com/luntiklaelite/classToMapping) (не универсальное решение, требуется настройка на плагин и написание кода определённым образом)
  - первая миграция должна содержать пустые методы `Up()` и `Down()` для корректного удаления всех структур из базы данных
- **ReportTests** - проект приложения для быстрого формирования паспорта моста без запуска ITSGIS

##### Как собрать и запустить проект

1. Установить всё по инструкции "Установка плагина ITSGIS.txt"
2. Восстановить требуемые пакеты:  В обозревателе решений Visual Studio нажать правой кнопкой мыши на решение -> Управление пакетами NuGet для решения -> Около надписи Источник пакета нажать на параметры (значок шестерёнки) -> Добавить в доступные источники пакетов новый источник и указать путь до него - \\\\IC127\packages, после этого пакеты восстановятся автоматически
3. В таблицу layerobject добавить слой "Мосты", как это сделать описано в файле "Известные ошибки.doc"

##### Особенности реализации плагина

1. При успешной сборке все нужные файлы для установки в ITSGIS (все сборки, конфиг клиента и сервера) копируются в каталог binDistrib/Debug/ или binDistrib/Release
2. Особая структура рендерера: геометрии мостовых сооружений расчитываются один раз, и пересчитываются только при изменении геометрии, а не при перерисовке карты, что обеспечивает более быструю отрисовку (кроме первой отрисовки карты)
3. Создание слоя при нажатии на кнопки на панели плагина, возможные варианты: 
   - Слой есть -> ничего
   - Слоя нет, нет прав на запись -> ничего
   - Слоя нет, есть права на запись
     - Порядок слоя занят -> Ошибка: В текущей карте уже есть слой с порядком n
     - Порядок слоя свободен -> создание слоя, проверка наличия слоя в бд
       - Слой есть -> ничего
       - Слоя нет -> Ошибка: Не удалось добавить слой, при следующем нажатии будет повторная попытка создать слой

##### Как запустить проект теста паспортов (ReportTests)

1. Первым аргументом при запуске проекта указать название файла с путём, в который сохранится отчёт по сводной ведомости, вторым аргументом название файла с путём, в который сохранится паспорт моста.

##### Откат миграции

- Перед откатом миграции желательно удалить вручную все мосты с карты, иначе геометрии и стили останутся в бд.

#### Не реализованные функции

1. Удобное добавление дефектов
2. Информация о расположении обустройств, коммуникаций
3. Возможность указания диапазона уклонов
4. Информация о главной балке не соответствует инструкции по диагностике мостов
5. Группировка геообъектов
6. Отмена группировки
7. Разделение геометрии
8. Привязка моста к ближайшему населённому пункту
9.  Справочник
10.  Отмена изменений (Undo)
11.  Возврат изменений (Redo)
12.  Инвертирование начала моста
13.  Перемещение моста, при котором нельзя редактировать геометрию

#### Известные ошибки в плагине